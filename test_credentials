#!groovy
pipeline {
    agent any

    environment {
        GITHUB_CREDENTIALS = 'github-ssh'   // SSH для GitHub
        PROD_CREDENTIALS   = 'prod-ssh-key' // SSH для Prod
        DOCKER_REGISTRY = 'docker.io' 
        DOCKER_CRED_ID = 'dockerhub-creds'
        PROD_USER          = 'jenkinsdeploy'
        PROD_IP            = '185.207.66.75' 
    }

    stages {
        stage('Test GitHub SSH') {
            steps {
                sshagent([GITHUB_CREDENTIALS]) {
                    sh 'ssh -T git@github.com || true'
                }
            }
        }
        stage('Test Docker Login') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${DOCKER_CRED_ID}", usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh '''
                        echo "Пробуем docker login..."
                        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin $DOCKER_REGISTRY
                        docker logout $DOCKER_REGISTRY
                    '''
                }
            }
        }
        stage('Test Prod SSH') {
            steps {
                sshagent([PROD_CREDENTIALS]) {
                    sh "ssh -o StrictHostKeyChecking=no ${PROD_USER}@${PROD_IP} 'echo SSH to Prod OK'"
                }
            }
        }
    }
}
